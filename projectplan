

# ğŸ§  Freeform-Next: AI Whiteboard for iPad

An iPad-first infinite canvas with **Apple Pencil** and **on-device AI** that turns chats into **structured mind maps** with draggable blocks, smart connectors, and fast offline performance. Privacy-first, collaboration-ready.

---

## âœ¨ Highlights (Whatâ€™s better than Freeform)

* **AI â†’ Mind Map**: turn any prompt or chat into a clean topic tree (nodes + connectors) on-device.
* **Pencil-native UX**: PencilKit drawing + Pencil Pro gestures (where available).
* **Document-based**: each board is a document; supports multi-window, Files app, and iCloud Drive.
* **Offline-first**: everything local by default; sync/collab can be enabled later.
* **Export anywhere**: PNG/PDF/JSON (mind-map tree), plus share sheets and Quick Look.

---

## âœ… Feature Matrix

| Category                            | MVP                       | Polished                        | Pro                                       |
| ----------------------------------- | ------------------------- | ------------------------------- | ----------------------------------------- |
| Infinite canvas (pan/zoom, inertia) | âœ…                         |                                 |                                           |
| Apple Pencil drawing (PencilKit)    | âœ…                         | Pressure/tilt smoothing         | Custom tools, Pencil Pro squeeze/roll     |
| Blocks (text nodes)                 | âœ…                         | Rich text (TextKit 2), styles   | Media nodes (images, PDFs, links preview) |
| Connectors (auto layout + manual)   | âœ…                         | Orthogonal/spline routing       | Auto-reroute on move, labels              |
| AI â†’ Mind Map (on-device)           | âœ… JSON tree               | Topic deduplication, clustering | Incremental refine (â€œexpand node withâ€¦â€)  |
| Undo/Redo, Snap-to-grid/guides      | âœ…                         | Smart alignment                 | Layout presets (tree/radial/force)        |
| Persistence (local)                 | âœ… Core Data               | Autosave/versioning             | Time-machine timeline                     |
| Import/Export                       | âœ… PNG/PDF/JSON            | SVG export                      | Freeform export/interop (if feasible)     |
| Accessibility                       | âœ… Dynamic Type, VoiceOver | Focus order for nodes           | Full keyboard control                     |
| Multi-window & Files integration    | âœ…                         | Recent documents                |                                           |
| Collaboration (optional)            |                           | CKShare link                    | Real-time, conflict-free CRDT             |
| App Intents & Shortcuts             |                           | Quick actions                   | Automations (e.g., â€œMind map clipboardâ€)  |
| TipKit onboarding                   | âœ…                         | Contextual tips                 | Progressive education                     |

---

## ğŸ§° Tech Stack (Right tools, no fluff)

* **UI & App**

  * **SwiftUI** for app chrome, inspectors, tool palettes, document browser (DocumentGroup).
  * **UIKit + PencilKit** for the performant canvas: `PKCanvasView` as the drawing layer, with overlays for nodes/connectors.
  * **UIScrollView** (or custom) backing for zoomable, tiled canvas; SwiftUI embeds via `UIViewRepresentable`.
* **Drawing & Layout**

  * **PencilKit** (`PKCanvasView`, `PKToolPicker`) for strokes.
  * **Core Animation** (`CAShapeLayer`) or **Metal-backed** rendering for connectors when density grows.
  * **TextKit 2** for rich text in nodes (inline formatting, lists, code).
* **AI (On-device)**

  * **Core ML** model that converts free text â†’ topic tree (JSON). Options:

    * Small instruction-tuned transformer (quantized) for topic extraction + outline.
    * Lightweight embedding + clustering pipeline for â€œgroupingâ€/dedupe.
  * **NLTokenizer** / custom parser for sentence/phrase chunking.
  * **BNNS/MPSGraph** via Core ML for acceleration where needed.
* **Data & Files**

  * **Document-based app** (`UTType` custom â€œ.aiboardâ€), with **Core Data** graph schema.
  * Optional sync via **NSPersistentCloudKitContainer** (opt-in).
  * **Codable** mind-map JSON for import/export.
* **Share, Preview, Export**

  * **PDFKit** / Core Graphics for PDF export.
  * **Quick Look** for board previews.
  * **UIActivityViewController / ShareLink** for share.
* **System Integration**

  * **App Intents** + **Shortcuts** (Create Board from clipboard text, Export as PDF, Append selection to node).
  * **TipKit** for in-context tips.
  * **Widgets** (later): recent boards.
* **Testing & Quality**

  * **XCTest** (+ Snapshot testing for nodes/connectors).
  * **Xcode Instruments** (Time Profiler, Core Animation FPS).
  * **MetricKit** for crash/perf telemetry (opt-in, privacy-safe).

> ğŸ“Œ We deliberately avoid any private â€œApple Intelligenceâ€ APIs. Everything here is publicly shippable on the App Store.

---

## ğŸ§  Data Model (Core Data)

**Entities**

* `Board`: id, title, createdAt, updatedAt, viewport, theme
* `Node`: id, boardID, text (RTF/Markdown), frame (x,y,w,h), style, zIndex, metadata
* `Edge`: id, boardID, sourceNodeID, targetNodeID, style (orthogonal/spline), label
* `Stroke`: id, boardID, `PKDrawing` data blob (compressed)
* `Attachment` (optional): id, nodeID, type (image/pdf/link), payload URL/thumbnail

**Why Core Data?**
Fast fetches for large boards, easy undo/redo integration, CloudKit later with minimal rework.

---

## ğŸ”„ AI â†’ Mind Map Contract

* **Input**: free text (chat history or a single prompt)
* **Output** (strict JSON; small schema):

```json
{
  "topic": "Root Topic",
  "children": [
    { "topic": "Child A", "children": [ { "topic": "Leaf" } ] },
    { "topic": "Child B" }
  ]
}
```

* **Post-processing**:

  * Deduplicate topics (case/lemma).
  * Limit breadth/depth via heuristics (e.g., max 7 children per node).
  * Style mapping (root = bold, children = normal).
  * Auto-layout (tree/radial). Re-run layout only for changed subtrees.

---

## ğŸ§­ Development Flow (8 sprints)

**Sprint 0 â€“ Project & Foundations (1 week)**

* App template: SwiftUI App + `DocumentGroup`.
* Custom UTType `com.yourco.aiboard`.
* Empty canvas with pan/zoom; FPS overlay; snapshot tests scaffold.

**Sprint 1 â€“ Pencil & Canvas (1â€“2 weeks)**

* Integrate `PKCanvasView` + `PKToolPicker`.
* Stroke persistence (`PKDrawing` in Core Data).
* Smooth zooming; tile backing store for large canvases.

**Sprint 2 â€“ Nodes & Connectors (2 weeks)**

* Node view (SwiftUI) embedded over canvas; drag, resize, edit.
* Connector engine: straight + orthogonal; anchors on node sides.
* Hit-testing; selection model; alignment guides & snap.

**Sprint 3 â€“ AI MVP (2 weeks)**

* Core ML model loader & inference wrapper.
* Prompt â†’ JSON tree â†’ node/edge graph.
* Basic auto-layout (hierarchical tree, left-to-right).
* â€œGenerate from promptâ€ & â€œRegenerate selected subtreeâ€.

**Sprint 4 â€“ Persistence & Document UX (1 week)**

* Auto-save/auto-versioning; recent documents; thumbnails.
* Import/export: PNG/PDF/JSON.
* Quick Look preview extension.

**Sprint 5 â€“ Polish & Performance (1â€“2 weeks)**

* TextKit 2 rich text in nodes (bold, lists, inline code).
* Large board perf: layer reuse, throttled relayout, off-main decoding.
* Accessibility pass (VoiceOver labels for nodes/edges; rotor order).

**Sprint 6 â€“ Nice-to-Haves (1â€“2 weeks)**

* Pencil Pro gestures: squeeze = quick node; roll = tool size.
* TipKit onboarding; App Intents + Shortcuts.
* Theming; radial/force-directed layout option.

**Sprint 7 â€“ Optional Collaboration (later)**

* Turn on **NSPersistentCloudKitContainer**; document sharing with **CKShare**.
* (Advanced) migrate to CRDT for real-time multi-cursor editing.

---

## ğŸ§ª Testing Strategy

* **Unit**: AI parsing â†’ JSON schema, layout math, Core Data CRUD.
* **Snapshot**: node/connector rendering across scales, light/dark, languages.
* **Performance**: target 60fps with 1k nodes / 5k edges on M-series iPads; memory < 300MB active.
* **Stability**: Fuzz drag/resizes, random graph generators, autosave under stress.
* **Accessibility**: VoiceOver scripted runs; large text; high contrast.

---

## ğŸ“¤ Export & Interop

* **PNG**: current viewport or full board at scale.
* **PDF**: paginated or giant single page; vector connectors; rasterized strokes.
* **JSON**: full `Board` graph for backups and third-party tooling.
* **(Optional)** SVG for mind-map interchange (connectors as paths; nodes as groups).

---

## ğŸ” Privacy & Offline

* Default is fully offline; no network permissions.
* Opt-in cloud sync & crash reports.
* Model files stored on-device; allow users to delete models & caches.
* Clear â€œwhat AI does locallyâ€ disclosure in Settings.

---

## ğŸ—‚ Project Layout

```
FreeformNext/
â”œâ”€ App/
â”‚  â”œâ”€ FreeformNextApp.swift
â”‚  â””â”€ Document/ (DocumentGroup, thumbnails, previews)
â”œâ”€ Canvas/
â”‚  â”œâ”€ CanvasViewController.swift        // UIScrollView + PKCanvasView
â”‚  â”œâ”€ CanvasHosting.swift               // SwiftUI bridge
â”‚  â”œâ”€ ConnectorLayer.swift              // CAShapeLayer routing
â”‚  â””â”€ HitTesting.swift
â”œâ”€ Nodes/
â”‚  â”œâ”€ NodeView.swift                    // SwiftUI
â”‚  â”œâ”€ NodeModel.swift
â”‚  â””â”€ TextKitSupport/
â”œâ”€ AI/
â”‚  â”œâ”€ MindMapModel.mlmodel
â”‚  â”œâ”€ MindMapInference.swift
â”‚  â””â”€ PostProcessing.swift
â”œâ”€ Data/
â”‚  â”œâ”€ PersistenceController.swift       // Core Data + autosave
â”‚  â”œâ”€ Models.xcdatamodeld
â”‚  â””â”€ Serialization/ (JSON import/export)
â”œâ”€ Features/
â”‚  â”œâ”€ Export/
â”‚  â”œâ”€ Shortcuts/
â”‚  â””â”€ Tips/
â”œâ”€ Tests/
â”‚  â”œâ”€ Unit/
â”‚  â””â”€ Snapshot/
â””â”€ README.md
```

---

## ğŸ§© Implementation Notes & Traps (so you donâ€™t step on them)

* **Canvas perf**: keep nodes/edges in lightweight layers; avoid too many SwiftUI views at deep zooms. Defer expensive text layout until idle.
* **Gesture conflicts**: Pencil draws; finger pans; long-press = node menu. Respect Appleâ€™s Pencil/finger conventions.
* **Auto-layout**: run layout on a background queue; animate to final positions; throttle during active drags.
* **Undo/Redo**: leverage Core Data undo manager + explicit transactions for grouped edits (e.g., â€œAI insert subtreeâ€).
* **File size**: compress `PKDrawing` blobs; dedupe attachments; lazy-load thumbnails.
* **AI latency**: cache embeddings; pre-warm model; cap output size via prompts + post-filters.

---

## ğŸ§¾ Roadmap (Issues you can file today)

* [ ] Canvas: tiled backing store
* [ ] Nodes: selection ring + resize handles
* [ ] Connectors: orthogonal router with obstacle avoidance
* [ ] AI: model selection & quantization plan
* [ ] Export: vector PDF with raster strokes
* [ ] TipKit: first-run tips
* [ ] App Intents: â€œGenerate board from clipboardâ€
* [ ] Accessibility: VoiceOver labels for connectors (â€œA â†’ Bâ€)
* [ ] Localization: base strings & RTL layout sanity checks

---

## ğŸ“ Example App Intents (Shortcuts)

* **Generate Mind Map from Clipboard**
* **Export Current Board as PDF to Files**
* **Append Selected Text to Node**
* **Create New Board From URL (scrape headings â†’ topics)**

---

## ğŸ“˜ Licensing

MIT. See `LICENSE`.

---

### FAQ (dev-focused)

* **Why UIKit for canvas if the app is SwiftUI?**
  For dense, zoomable, layered graphics, UIKit + Core Animation remains faster and more predictable. SwiftUI wraps it nicely for the rest.

* **Which model should I start with?**
  Start tiny: a distilled/quantized transformer (few hundred MB) tuned to produce concise outline JSON. Add an embedding step only if you need clustering/deduplication.

* **Can I ship without collaboration?**
  Absolutely. Ship single-player first; add CloudKit sync later without redesign thanks to the document-based + Core Data foundation.

--
